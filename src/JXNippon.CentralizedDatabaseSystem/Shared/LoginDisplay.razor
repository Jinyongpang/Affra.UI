@using JXNippon.CentralizedDatabaseSystem.Shared.Notifications
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Security.Claims

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

<AuthorizeView>
    <Authorized>
        <Space>
            <SpaceItem>
                <div class="align-self-center flex-row order-md-first">
                    <div class="nav-item dropdown d-lg-none d-xl-flex me-3">
                        <Search Placeholder="Search" ClassicSearchIcon/>
                    </div>
                </div>               
            </SpaceItem>
            <SpaceItem>
                <PersonalMessageIcon/>
            </SpaceItem>
        </Space>
        <RadzenProfileMenu>
            <Template>
                <Avatar Style="vertical-align: middle;" Size="large">
                    <span style="font-size: 16px;">@this.GetAvatarName(context.User.Identity.Name)</span>
                </Avatar>
            </Template>
            <ChildContent>
                <Card Size="large" Style="min-width:380px;">
                    <TitleTemplate>

                    </TitleTemplate>
                    <Extra>
                        <a @onclick="BeginLogout"><span class="toprow-nav-title">Logout</span></a>
                    </Extra>
                    <Body>
                        <div class="row min-w-100">
                            <div class="col">
                                 <Avatar Style="vertical-align: middle;" Size="64">
                                    <span style="font-size: 32px;">@this.GetAvatarName(context.User.Identity.Name)</span>
                                 </Avatar>
                            </div>
                            <div class="col">
                                <div class="row">
                                    <h3 style="font-weight:bold">@context.User.Identity.Name</h3>
                                </div>
                                <div class="row">
                                    <span>@this.GetEmail(@context.User)</span>
                                </div>
                            </div>
                        </div> 
                    </Body>
                </Card>
            </ChildContent>
        </RadzenProfileMenu>
    </Authorized>
</AuthorizeView>

@code{
    private async Task BeginLogout(MouseEventArgs args)
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }

    private string GetAvatarName(string name)
    {
        string[] names = name.Split(' ');
        string result = string.Empty;
        result += names[0][0];
        if (names.Length > 1)
        {
            result += names[1][0];
        }

        return result;
    }

    private string GetEmail(ClaimsPrincipal user)
    {
        return this.GetValue(user, "preferred_username");
    }

    private string GetValue(ClaimsPrincipal user, string key)
    {
        return user.Claims
            .Where(x => x.Type.Contains(key))
            .FirstOrDefault()?
            .Value;
    }
}
